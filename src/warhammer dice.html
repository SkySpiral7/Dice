<!DOCTYPE HTML>
<html>
<head>
<title>Warhammer Dice</title>
<meta charset="ASCII" />
<script id="DiceInclude" src="library/include.js"></script><!--the code to test-->
<script type="text/javaScript">
//this script block is hacks for warhammer because the original API is lacking
Draw.WarhammerBellCurve = function(diceCount, toHitValue, toWoundValue, toSaveValue, extraSave, secondColumn){
    if(secondColumn==undefined) secondColumn='>=';
    var out = '';

    var rollData=[];
    for(var i=0; i < diceCount; i++) rollData.push(0);  //needs to start as this for it to combine correctly
    rollData.push(1);  //[diceCount]
    //the start data represents that the dice being equal to diceCount is 100% and all other values are 0%
    if(toHitValue > 1) rollData=WarhammerCombine(rollData, toHitValue);
    if(toWoundValue > 1) rollData=WarhammerCombine(rollData, toWoundValue);
    if(toSaveValue < 7) rollData=WarhammerCombine(rollData, 8-(toSaveValue));  //weird but true
    if(extraSave < 7) rollData=WarhammerCombine(rollData, 8-(extraSave));

    out += Draw.generateBinomialTable(rollData, secondColumn);  //must be sent 1D
    document.getElementById('graphResults').innerHTML += out;

   function WarhammerCombine(originalCurve, targetNumber){
       var results=[originalCurve[0]];  //set [0]. 0 can't be sent to Warhammer. the number is as is
      for (var diceIndex=1; diceIndex < originalCurve.length; diceIndex++)
      {
          if(originalCurve[diceIndex]==0) continue;  //ignore the impossible values
          var rollData=Warhammer(diceIndex, targetNumber);
         for (var i=0; i < rollData.length; i++)
         {
             var chanceOfSuccess=rollData[i]*originalCurve[diceIndex];  //mulitply because both must be true
             if(results[i]==undefined) results[i]=chanceOfSuccess;
             else results[i]+=chanceOfSuccess;  //add exclusive events for either to be true
         }
      }
       for(var i=0; i < results.length; i++) if(results[i]==undefined) results[i]=0;  //everything else did not occur. must fix up the number
       return results;
   }
   function Warhammer(diceCount, targetNumber){
       var diceArray = new DicePool(diceCount+'d6').getAllDice();
       var finishedPolys=[];
      for (var diceIndex=0; diceIndex < diceArray.length; diceIndex++)
      {
          var polyNom=everyDieValueWeighted(diceArray[diceIndex]);
          var possibleNumberWins=0;
          for(var i=0; i < polyNom.length; i++)  //count probability for each
             if(polyNom[i][0] >= targetNumber) possibleNumberWins++;
          var binomProb=generate_Binomials(1, (possibleNumberWins/polyNom.length));
          var polyNom=[];
         for (var i=0; i < binomProb.length; i++)
         {
             polyNom.push([i, binomProb[i]]);  //to be in the form of [value, freq]
         }
          finishedPolys.push(polyNom);  //stored as polys so I can multiply them
      }
       finishedPolys=Polynomial.multiplyPolynomials(finishedPolys, new DicePool());  //given an empty pool
       var results=[];  //strip out the results so that it is 1D again
       for(var i=0; i < finishedPolys.length; i++) results[finishedPolys[i][0]]=finishedPolys[i][1];
       for(var i=0; i < results.length; i++) if(results[i]==undefined) results[i]=0;  //everything else did not occur. must fix up the number
       return results;
   }
};
</script>
<script type="text/javaScript">
//this script block needs to stay here because it is page specific
function processWoundMax(stats)
{
   var maxWounds = Number.parseInt(document.getElementById('woundMax').value);
   document.getElementById('woundMax').value = maxWounds;
   if(maxWounds < 1) throw new Error('The maximum number of wounds must be at least 1');
   while (stats[stats.length-1].result > maxWounds && stats.length > 1)  //too many wounds
   {
      stats[stats.length-2].probability += stats[stats.length-1].probability;
      stats.pop();  //then remove the last
   }
}
Draw.generateBinomialTable = function(stats, secondColumn)
{
   if('=' === secondColumn) secondColumn = '==';
   processWoundMax(stats);
   var aggregates = Statistics.calculateAggregates(stats);

   minResult.textContent = aggregates.minimum;
   maxResult.textContent = aggregates.maximum;
   avgResult.textContent = aggregates.mean.toFixed(2);
   devResult.textContent = aggregates.standardDeviation.toFixed(3);

   var output = GenerateHtml.statistics(stats, secondColumn);
   return output.replace('<th>Roll</th>', '<th>Wounds Inflicted</th>');
};
function attack(){
    var input = {};
    input.diceCount = Number.parseInt(document.getElementById('diceCount').value);
    document.getElementById('diceCount').value = input.diceCount;
    input.maxWounds = Number.parseInt(document.getElementById('woundMax').value);
    document.getElementById('woundMax').value = input.maxWounds;
    input.toHitValue = Number.parseInt(document.getElementById('toHitValue').value);
    document.getElementById('toHitValue').value = input.toHitValue;
    input.toWoundValue = Number.parseInt(document.getElementById('toWoundValue').value);
    document.getElementById('toWoundValue').value = input.toWoundValue;
    input.saveValue = Number.parseInt(document.getElementById('saveValue').value);
    document.getElementById('saveValue').value = input.saveValue;
    input.reanimateOrNoPainValue = Number.parseInt(document.getElementById('reanimateOrNoPainValue').value);
    document.getElementById('reanimateOrNoPainValue').value = input.reanimateOrNoPainValue;
    var customColumn = document.getElementById('customColumn').value;

    document.getElementById('graphResults').textContent = '';
    hitResult.textContent = '-';
    woundedResult.textContent = '-';
    unsaveWoundsResult.textContent = '-';
    minResult.textContent = '-';
    maxResult.textContent = '-';
    avgResult.textContent = '-';
    devResult.textContent = '-';
   try{
       var output = Prebuilt.WarhammerAttackUnit(input);
       //this is done before drawing in case of error
       hitResult.textContent = output.hit;  //always exists
       if(undefined !== output.wounded) woundedResult.textContent = output.wounded;
       if(undefined !== output.unsavedWounds) unsaveWoundsResult.textContent = output.unsavedWounds;
       Draw.WarhammerBellCurve(input.diceCount, input.toHitValue, input.toWoundValue, input.saveValue, input.reanimateOrNoPainValue, customColumn);
   }
    catch(error){alert('Error: ' + error.message); throw error;}
};
</script>
<a>The random values are in order: number of enemies hit, number wounded, number of unsaved wounds.</a>
<form action="javascript:attack();">
<table>
   <tr>
      <td style="text-align:right;">Number of Dice: </td>
      <td><input type="text" value="15" size="5" id="diceCount" /></td>
      <td>Random Values</td>
      <td>Statistics</td>
   </tr>
   <tr>
      <td style="text-align:right;">Number of Wounds Possible: </td>
      <td><input type="text" value="15" size="5" id="woundMax" /></td>
      <td />
   </tr>
   <tr>
      <td style="text-align:right;">To Hit Value: </td>
      <td><input type="text" value="3" size="5" id="toHitValue" /></td>
      <td id="hitResult" style="text-align:center;">-</td>
      <td><b>Min:</b> <span id="minResult" style="text-align:center;">-</span></td>
   </tr>
   <tr>
      <td style="text-align:right;">To Wound Value: </td>
      <td><input type="text" value="3" size="5" id="toWoundValue" /></td>
      <td id="woundedResult" style="text-align:center;">-</td>
      <td><b>Max:</b> <span id="maxResult" style="text-align:center;">-</span></td>
   </tr>
   <tr>
      <td style="text-align:right;">To Save Value: </td>
      <td><input type="text" value="4" size="5" id="saveValue" /></td>
      <td />
      <td><b>Avg:</b> <span id="avgResult" style="text-align:center;">-</span></td>
   </tr>
   <tr>
      <td style="text-align:right;">Reanimation or Feel No Pain: </td>
      <td><input type="text" value="7" size="5" id="reanimateOrNoPainValue" /></td>
      <td id="unsaveWoundsResult" style="text-align:center;">-</td>
      <td><b>Std Dev:</b> <span id="devResult" style="text-align:center;">-</span></td>
   </tr>
   <tr>
      <td style="text-align:right;">Custom Column: </td>
      <td><input type="text" value=">=" size="5" id="customColumn" /></td>
      <td /><td />
   </tr>
   <tr><td /><td><input type="submit" value="Attack" /></td><td /><td /></tr>
</table>
</form>
<br />
<div id="graphResults"></div>
<br /><br /><br /><br />
</html>
