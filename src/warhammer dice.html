<!DOCTYPE HTML>
<html>
<head>
<title>Warhammer Dice</title>
<meta charset="ASCII" />
<script type="text/javaScript" src="library/main.js"></script>
<script type="text/javaScript">
//this block is hacks for warhammer because the original API is lacking
function WarhammerAttackUnit(diceCount, toHitValue, toWoundValue, saveValue, extraSaveValue){
    if(typeof(diceCount)!=="number" || isNaN(diceCount)) throw new Error("WarhammerAttackUnit, diceCount ("+diceCount+") the must be a number type.");
    if(typeof(toHitValue)!=="number" || isNaN(toHitValue)) throw new Error("WarhammerAttackUnit, toHitValue ("+toHitValue+") the must be a number type.");
    if(toHitValue > 6) return ["Impossible"];
    if(typeof(toWoundValue)!=="number" || isNaN(toWoundValue)) throw new Error("WarhammerAttackUnit, toWoundValue ("+toWoundValue+") the must be a number type.");
    if(toWoundValue > 6) return ["-", "Impossible"];
    if(typeof(extraSaveValue)!=="number" || isNaN(extraSaveValue)) extraSaveValue=7;
    if(saveValue===undefined) saveValue=7;  //an impossible number
    if(typeof(saveValue)!=="number" || isNaN(saveValue)) throw new Error("WarhammerAttackUnit, saveValue ("+saveValue+") the must be a string type.");

    var attackRolled=new DicePool(diceCount+"d6").roll();
    var successCount=0;
    var output=[];
   for (var i=0; i < attackRolled.length; i++)
   {
       if(attackRolled[i] >= toHitValue) successCount++;
   }
    if(successCount==0) return ['None hit'];

    output.push(successCount);
    attackRolled=new DicePool(successCount+"d6").roll();
    successCount=0;
   for (var i=0; i < attackRolled.length; i++)
   {
       if(attackRolled[i] >= toWoundValue) successCount++;
   }
    if(successCount==0){output.push('None wounded'); return output;}

    output.push(successCount);
    attackRolled=new DicePool(successCount+"d6").roll();
    successCount=0;
   for (var i=0; i < attackRolled.length; i++)
   {
       if(attackRolled[i] < saveValue) successCount++;
   }
    if(successCount==0){output.push('All Saved'); return output;}
    output.push(successCount);
    if(extraSaveValue > 6) return output;
    //else:
    attackRolled=new DicePool(successCount+"d6").roll();
    successCount=0;
   for (var i=0; i < attackRolled.length; i++)
   {
       if(attackRolled[i] < extraSaveValue) successCount++;
   }
    if(successCount==0){output.push('All Saved'); return output;}
    output.push(successCount);
    return output;
};
Draw.WarhammerBellCurve = function(diceCount, toHitValue, toWoundValue, toSaveValue, extraSave, secondColumn){
    if(secondColumn==undefined) secondColumn='>=';
    var out = '';

    var rollData=[];
    for(var i=0; i < diceCount; i++) rollData.push(0);  //needs to start as this for it to combine correctly
    rollData.push(1);  //[diceCount]
    //the start data represents that the dice being equal to diceCount is 100% and all other values are 0%
    if(toHitValue > 1) rollData=WarhammerCombine(rollData, toHitValue);
    if(toWoundValue > 1) rollData=WarhammerCombine(rollData, toWoundValue);
    if(toSaveValue < 7) rollData=WarhammerCombine(rollData, 8-(toSaveValue));  //weird but true
    if(extraSave < 7) rollData=WarhammerCombine(rollData, 8-(extraSave));

    out += Draw.generateBinomialTable(rollData, secondColumn);  //must be sent 1D
    document.getElementById('graphResults').innerHTML += out;

   function WarhammerCombine(originalCurve, targetNumber){
       var results=[originalCurve[0]];  //set [0]. 0 can't be sent to Warhammer. the number is as is
      for (var diceIndex=1; diceIndex < originalCurve.length; diceIndex++)
      {
          if(originalCurve[diceIndex]==0) continue;  //ignore the impossible values
          var rollData=Warhammer(diceIndex, targetNumber);
         for (var i=0; i < rollData.length; i++)
         {
             var chanceOfSuccess=rollData[i]*originalCurve[diceIndex];  //mulitply because both must be true
             if(results[i]==undefined) results[i]=chanceOfSuccess;
             else results[i]+=chanceOfSuccess;  //add exclusive events for either to be true
         }
      }
       for(var i=0; i < results.length; i++) if(results[i]==undefined) results[i]=0;  //everything else did not occur. must fix up the number
       return results;
   }
   function Warhammer(diceCount, targetNumber){
       var diceArray = new DicePool(diceCount+'d6').getAllDice();
       var finishedPolys=[];
      for (var diceIndex=0; diceIndex < diceArray.length; diceIndex++)
      {
          var polyNom=everyDieValueWeighted(diceArray[diceIndex]);
          var possibleNumberWins=0;
          for(var i=0; i < polyNom.length; i++)  //count probability for each
             if(polyNom[i][0] >= targetNumber) possibleNumberWins++;
          var binomProb=generate_Binomials(1, (possibleNumberWins/polyNom.length));
          var polyNom=[];
         for (var i=0; i < binomProb.length; i++)
         {
             polyNom.push([i, binomProb[i]]);  //to be in the form of [value, freq]
         }
          finishedPolys.push(polyNom);  //stored as polys so I can multiply them
      }
       finishedPolys=Polynomial.multiplyPolynomials(finishedPolys, new DicePool());  //given an empty pool
       var results=[];  //strip out the results so that it is 1D again
       for(var i=0; i < finishedPolys.length; i++) results[finishedPolys[i][0]]=finishedPolys[i][1];
       for(var i=0; i < results.length; i++) if(results[i]==undefined) results[i]=0;  //everything else did not occur. must fix up the number
       return results;
   }
};
Draw.generateBinomialTable = function(rollData, secondColumn){
    if(rollData.length == 0) return '';
    var results=[];  //pad the results to 2D so I can use Draw.generateDiceSumTable
    for(var i=0; i < rollData.length; i++) results.push([i, rollData[i]]);

    var output=Draw.generateDiceSumTable(results, secondColumn);
    return output.replace('<th>Roll</th>', '<th>Wounds Inflicted</th>');
}
Draw.generateDiceSumTable = function(rollData, secondColumn){
    if(rollData.length==0) return;  //nothing to report
    if(secondColumn=='=') secondColumn='==';  //heh symmetry. adds an '=' so that eval can read it
    var maxWounds=Number(document.getElementById('woundMax').value);
    document.getElementById('woundMax').value=maxWounds;
    if(maxWounds < 1) throw new Error('The maximum number of wounds must be at least 1');
    if(maxWounds < rollData[0][0]) maxWounds=rollData[rollData.length-1][0];
   while (rollData[rollData.length-1][0] > maxWounds)  //too many wounds
   {
       rollData[rollData.length-2][1]+=rollData[rollData.length-1][1];  //add the 2 freq
       rollData.pop();  //then remove the top
   }
    var min, max, count=0, sum=0;
   for (var i=0; i < rollData.length; i++)
   {
       if(rollData[i][1]==0) continue;  //freq is 0 means it can't be done (shouldn't exist)
       if(min==undefined || rollData[i][0] < min) min = rollData[i][0];
       if(max==undefined || max < rollData[i][0]) max = rollData[i][0];
       count += rollData[i][1];
       sum += (rollData[i][0] * rollData[i][1]);  //must be wieghted since the ones that occur more often are more likely
   }
    var deviationSquareSum = 0;
    var avg = sum / count;
   for (var i=0; i < rollData.length; i++)
   {
       //if(rollData[i][1]==0) continue;
       var dev = rollData[i][0] - avg;
       dev *= dev;  //squared
       deviationSquareSum += (dev * rollData[i][1]);  //weighted
   }
    var standardDeviation = Math.sqrt(deviationSquareSum / count);

    minResult.textContent=min;
    maxResult.textContent=max;
    avgResult.textContent=avg.toFixed(2);
    devResult.textContent=standardDeviation.toFixed(3);

    return genTable(rollData, secondColumn);
   function genTable(rollData, secondColumn){
       if(rollData.length == 0) return '';
       var max = 0;
       var totalFreq = 0;
       var out = '';
       var secondValues=[];

      for (var i=0; i < rollData.length; i++) {
          if(rollData[i][1]==0){secondValues.push(0); continue;}
          if(max < rollData[i][1]) max = rollData[i][1];
          totalFreq += rollData[i][1];
          var secondSum=0;
         for (var j=0; j < rollData.length; j++) {
             if(eval(''+rollData[j][0]+secondColumn+rollData[i][0])) secondSum+=rollData[j][1];
         }
          secondValues.push(secondSum);
      }

       out = '<table border="1" cellpadding="0" cellspacing="2" width="100%">';
       out += "\n";
       out += '<tr><th>Roll</th>';
       out += '<th>Chance</th><th>'+secondColumn.replace('>', '&gt;').replace('<', '&lt;')+'</th><th align="center">Bar</th></tr>';
       out += "\n";

      for (var i=0; i < rollData.length; i++) {
          if(rollData[i][1]==0) continue;  //roll isn't possible
          out += '<tr><td align="center" width="1%">' + rollData[i][0];  //roll
          out += '</td><td align="right" width="1%">';
          out += (100 * rollData[i][1] / totalFreq).toFixed(3);  //non-freq is weighted but might not be the probability
          out += '%</td><td align="right" width="1%">';
          out += (100 * secondValues[i] / totalFreq).toFixed(3);
          out += '%</td><td valign="center">';
          out += '<div style="background-color: ';
          if(rollData[i][1] == max) out += 'green';  //not rounded
          else out += 'blue';
          out += '; width:' + (100 * rollData[i][1] / max).toFixed(3)+'%; height: 0.8em">&nbsp;</div>';
          out += '</td></tr>';
          out += "\n";
      }
       out += '</table>';
       return out;
   }
}
function attack(){
    var diceCount=Number(document.getElementById("diceCount").value);
    document.getElementById("diceCount").value=diceCount;
    var toHitValue=Number(document.getElementById("toHitValue").value);
    document.getElementById("toHitValue").value=toHitValue;
    var toWoundValue=Number(document.getElementById("toWoundValue").value);
    document.getElementById("toWoundValue").value=toWoundValue;
    var saveValue=Number(document.getElementById("saveValue").value);
    document.getElementById("saveValue").value=saveValue;
    var extraSaveValue=Number(document.getElementById("extraSaveValue").value);
    document.getElementById("extraSaveValue").value=extraSaveValue;
    var customColumn=document.getElementById("customColumn").value;

    document.getElementById("graphResults").textContent="";
    toHitResult.textContent='-';
    toWoundResult.textContent='-';
    toSaveResult.textContent='-';
    extraSaveResult.textContent='-';
    minResult.textContent='-';
    maxResult.textContent='-';
    avgResult.textContent='-';
    devResult.textContent='-';
   try{
       var holder=WarhammerAttackUnit(diceCount, toHitValue, toWoundValue, saveValue, extraSaveValue);
       //this is done before drawing in case of error
       toHitResult.textContent=holder[0];  //always exists
       if(holder.length > 1) toWoundResult.textContent=holder[1];
       if(holder.length > 2) toSaveResult.textContent=holder[2];
       if(holder.length > 3) extraSaveResult.textContent=holder[3];
       Draw.WarhammerBellCurve(diceCount, toHitValue, toWoundValue, saveValue, extraSaveValue, customColumn);
   }
    catch(error){alert("Error: "+error.message+"\n");}
};
</script>
<a>The random values are in order: number of enemies hit, number wounded, number that saved, and number that made the second save.</a>
<form action="javascript:attack();">
<table>
   <tr>
      <td style='text-align:right;'>Number of Dice: </td>
      <td><input type="text" value="15" size='5' id='diceCount' /></td>
      <td>Random Values</td>
      <td>Statistics</td>
   </tr>
   <tr>
      <td style='text-align:right;'>Number of Wounds Possible: </td>
      <td><input type="text" value="15" size='5' id='woundMax' /></td>
      <td />
   </tr>
   <tr>
      <td style='text-align:right;'>To Hit Value: </td>
      <td><input type="text" value="3" size='5' id='toHitValue' /></td>
      <td id='toHitResult' style='text-align:center;'>-</td>
      <td><b>Min:</b> <span id='minResult' style='text-align:center;'>-</span></td>
   </tr>
   <tr>
      <td style='text-align:right;'>To Wound Value: </td>
      <td><input type="text" value="3" size='5' id='toWoundValue' /></td>
      <td id='toWoundResult' style='text-align:center;'>-</td>
      <td><b>Max:</b> <span id='maxResult' style='text-align:center;'>-</span></td>
   </tr>
   <tr>
      <td style='text-align:right;'>To Save Value: </td>
      <td><input type="text" value="4" size='5' id='saveValue' /></td>
      <td id='toSaveResult' style='text-align:center;'>-</td>
      <td><b>Avg:</b> <span id='avgResult' style='text-align:center;'>-</span></td>
   </tr>
   <tr>
      <td style='text-align:right;'>Reanimation or Feel No Pain: </td>
      <td><input type="text" value="7" size='5' id='extraSaveValue' /></td>
      <td id='extraSaveResult' style='text-align:center;'>-</td>
      <td><b>Std Dev:</b> <span id='devResult' style='text-align:center;'>-</span></td>
   </tr>
   <tr>
      <td style='text-align:right;'>Custom Column: </td>
      <td><input type="text" value=">=" size='5' id='customColumn' /></td>
      <td /><td />
   </tr>
   <tr><td /><td><input type="submit" value="Attack" /></td><td /><td /></tr>
</table>
</form>
<br />
<div id="graphResults"></div>
<br /><br /><br /><br />
</html>
